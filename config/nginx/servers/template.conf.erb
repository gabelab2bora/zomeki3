<% zomeki_root = Rails.root -%>
server {
  listen 80;
  server_name <%= domain %>;
  root <%= public_path %>;
  access_log <%= zomeki_root %>/log/access_site_<%= '%04d' % id %>.log main;
  error_log <%= zomeki_root %>/log/error_site_<%= '%04d' % id %>.log warn;

  include <%= zomeki_root %>/config/nginx/servers_common.conf;

  location ^~ /<%= ZomekiCMS::ADMIN_URL_PREFIX %> {
    try_files $uri @proxy;
    <%- if use_basic_auth? -%>
    auth_basic_user_file <%="#{::File.dirname(public_path)}/.htpasswd_system"%>;
    auth_basic "Please enter your ID and password";
    <%- end -%>
  }

  location / {
    try_files $uri $uri/index.html @proxy;
    <%- if use_basic_auth? %>
    auth_basic_user_file <%="#{::File.dirname(public_path)}/.htpasswd"%>;
    auth_basic "Please enter your ID and password";
    <%- end -%>
    if ($is_mobile = 1) {
      rewrite ^(?!/_mobile)(.+)$ /_mobile$1 last;
    }

    if ($is_smartphone = 1) {
      rewrite ^(?!/_smartphone)(.+)$ /_smartphone$1 last;
    }

    if ($cookie_pc_view = 'on') {
      rewrite ^/_smartphone(/.*)$ $1 last;
    }

    if ($cookie_navigation_ruby = 'on') {
      rewrite ^(.*)/$ $1/index.html;
      rewrite ^(.+)\.html$ $1.html.r last;
    }
  }

  <%- basic_auth_users.directory_auth.each do |d| -%>
  location /<%=d.target_location%> {
    try_files $uri $uri/index.html @proxy;
    <%- if use_basic_auth? %>
    auth_basic_user_file <%="#{::File.dirname(public_path)}/.htpasswd_#{d.target_location}"%>;
    auth_basic "Please enter your ID and password";
    <%- end -%>

    if ($is_mobile = 1) {
      rewrite ^(?!/_mobile)(.+)$ /_mobile$1 last;
    }

    if ($is_smartphone = 1) {
      rewrite ^(?!/_smartphone)(.+)$ /_smartphone$1 last;
    }

    if ($cookie_pc_view = 'on') {
      rewrite ^/_smartphone(/.*)$ $1 last;
    }

    if ($cookie_navigation_ruby = 'on') {
      rewrite ^(.*)/$ $1/index.html;
      rewrite ^(.+)\.html$ $1.html.r last;
    }
  }
  <%- end if basic_auth_users.directory_auth.present? -%>
}
