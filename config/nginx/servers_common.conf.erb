<% zomeki_root = Rails.root -%>
location ~* /_(common|themes)/ {
  root <%= zomeki_root %>/public;
}

location /_api/ {
  error_page 418 = @puma; return 418;
}

location /<%= ZomekiCMS::ADMIN_URL_PREFIX %>/ {
  error_page 418 = @puma; return 418;
}

location / {
  try_files $uri @puma;

  if ($cookie_navigation_ruby = 'on') {
    rewrite ^(.*)/$ $1/index.html;
    rewrite ^(.+)\.html$ $1.html.r break;
  }
}

location @puma {
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  proxy_pass http://zomeki_puma;
}
